<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>SimpleClaw Dashboard</title>
<style>
  /* Mobile responsive styles */
  @media (max-width: 768px) {
    .layout { grid-template-columns: 1fr !important; }
    .sidebar { 
      display: none; 
      position: absolute; 
      top: 49px; 
      left: 0; 
      right: 0; 
      z-index: 99;
      border-bottom: 1px solid var(--border);
    }
    .sidebar.open { display: block; }
    .header-right { gap: 8px !important; }
    .status-grid { grid-template-columns: 1fr 1fr !important; }
    .macros-grid { grid-template-columns: 1fr 1fr !important; }
    .kanban-columns { grid-template-columns: 1fr !important; }
    .card { padding: 12px !important; }
    .main { padding: 12px !important; }
  }
  
  /* Hamburger menu */
  #mobileMenuBtn { display: none; }
  @media (max-width: 768px) {
    #mobileMenuBtn { 
      display: block !important; 
      background: none; 
      border: none; 
      font-size: 20px; 
      cursor: pointer;
      padding: 4px 8px;
    }
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2128;
    --border: #30363d;
    --text: #c9d1d9;
    --muted: #8b949e;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #d29922;
    --blue: #58a6ff;
    --purple: #bc8cff;
  }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  
  /* Header */
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; }
  header h1 { font-size: 16px; font-weight: 600; color: #f0f6fc; }
  .badge { padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 500; }
  .badge-green { background: #238636; color: #fff; }
  .badge-yellow { background: #9e6a03; color: #fff; }
  .badge-red { background: #b91c1c; color: #fff; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  #statusBadge { cursor: pointer; }
  
  /* Layout */
  .layout { display: grid; grid-template-columns: 240px 1fr; height: calc(100vh - 49px); }
  
  /* Sidebar */
  .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 12px 0; overflow-y: auto; }
  .nav-section { padding: 4px 12px; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin: 8px 0 4px; }
  .nav-item { display: flex; align-items: center; gap: 8px; padding: 7px 16px; font-size: 13px; color: var(--muted); cursor: pointer; border-left: 2px solid transparent; transition: all 0.15s; }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--blue); border-left-color: var(--blue); background: rgba(88, 166, 255, 0.07); }
  .nav-item .icon { font-size: 15px; width: 20px; text-align: center; }
  .nav-badge { margin-left: auto; background: var(--surface2); color: var(--muted); padding: 1px 6px; border-radius: 10px; font-size: 10px; }
  .nav-badge.red { background: #b91c1c22; color: var(--red); }
  
  /* Main content */
  .main { overflow-y: auto; padding: 20px; }
  .page { display: none; }
  .page.active { display: block; }
  
  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
  .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .card-title { font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  
  /* Status grid */
  .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
  .stat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px; }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .stat-value { font-size: 20px; font-weight: 700; color: var(--text); margin-top: 4px; }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .stat-green .stat-value { color: var(--green); }
  .stat-red .stat-value { color: var(--red); }
  .stat-yellow .stat-value { color: var(--yellow); }
  
  /* Models */
  .model-list { display: flex; flex-direction: column; gap: 6px; }
  .model-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: border-color 0.15s; }
  .model-item:hover { border-color: var(--blue); }
  .model-item.active-model { border-color: var(--green); background: rgba(63, 185, 80, 0.05); }
  .model-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .model-dot.active { background: var(--green); }
  .model-name { font-size: 13px; color: var(--text); flex: 1; }
  .model-provider { font-size: 11px; color: var(--muted); }
  .model-switch-btn { background: #238636; color: #fff; border: none; border-radius: 4px; padding: 3px 8px; font-size: 11px; cursor: pointer; opacity: 0; transition: opacity 0.15s; }
  .model-item:hover .model-switch-btn { opacity: 1; }
  .model-item.active-model .model-switch-btn { display: none; }
  
  /* Macros */
  .macros-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
  .macro-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; cursor: pointer; transition: all 0.15s; text-align: left; }
  .macro-btn:hover { border-color: var(--blue); background: rgba(88, 166, 255, 0.05); }
  .macro-btn .icon { font-size: 18px; margin-bottom: 6px; }
  .macro-btn .name { font-size: 13px; font-weight: 500; color: var(--text); }
  .macro-btn .desc { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .macro-btn.danger:hover { border-color: var(--red); background: rgba(248, 81, 73, 0.05); }
  .macro-btn.warning:hover { border-color: var(--yellow); background: rgba(210, 153, 34, 0.05); }
  
  /* Config editor */
  .editor-wrap { position: relative; }
  #configEditor { width: 100%; min-height: 400px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px; color: var(--text); font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; line-height: 1.6; resize: vertical; }
  #configEditor:focus { outline: none; border-color: var(--blue); }
  .editor-actions { display: flex; gap: 8px; margin-top: 8px; }
  
  /* Tasks */
  .task-item { padding: 10px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; }
  .task-item.high { border-left: 3px solid var(--red); }
  .task-item.medium { border-left: 3px solid var(--yellow); }
  .task-title { font-size: 13px; color: var(--text); font-weight: 500; }
  .task-meta { font-size: 11px; color: var(--muted); margin-top: 3px; }
  .task-content { font-size: 12px; color: var(--muted); margin-top: 4px; font-style: italic; }
  
  /* Messages */
  .msg-item { padding: 8px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 5px; }
  .msg-header { display: flex; align-items: baseline; gap: 6px; margin-bottom: 3px; }
  .msg-from { font-size: 12px; font-weight: 600; color: var(--blue); }
  .msg-to { font-size: 11px; color: var(--green); }
  .msg-time { font-size: 11px; color: var(--muted); margin-left: auto; }
  .msg-text { font-size: 12px; color: var(--text); }
  
  /* Send form */
  .send-form { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  select, input[type=text], textarea { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; color: var(--text); font-size: 13px; }
  select:focus, input:focus, textarea:focus { outline: none; border-color: var(--blue); }
  
  /* Buttons */
  .btn { border: none; border-radius: 6px; padding: 7px 14px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
  .btn-green { background: #238636; color: #fff; }
  .btn-green:hover { background: #2ea043; }
  .btn-blue { background: #1f6feb; color: #fff; }
  .btn-blue:hover { background: #388bfd; }
  .btn-red { background: #b91c1c; color: #fff; }
  .btn-red:hover { background: #dc2626; }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--text); }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  
  /* Terminal output */
  .terminal { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--green); min-height: 80px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
  
  /* Toast */
  .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 16px; border-radius: 8px; font-size: 13px; z-index: 999; display: none; animation: fadeIn 0.2s; }
  .toast.success { background: #238636; color: #fff; }
  .toast.error { background: #b91c1c; color: #fff; }
  .toast.info { background: #1f6feb; color: #fff; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
  
  /* Misc */
  .empty { color: var(--muted); font-size: 13px; text-align: center; padding: 24px; }
  .divider { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
  .loading { color: var(--muted); font-size: 12px; }
  .tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; }
  .tag-green { background: rgba(63, 185, 80, 0.15); color: var(--green); }
  .tag-blue { background: rgba(88, 166, 255, 0.15); color: var(--blue); }
</style>
</head>
<body>

<header>
  <button id="mobileMenuBtn" onclick="toggleSidebar()">â˜°</button>
  <span style="font-size:20px">ğŸ¦</span>
  <h1>SimpleClaw</h1>
  <span class="badge badge-green" id="statusBadge" onclick="navigate('status')" title="Click for details">â— Running</span>
  <div class="header-right">
    <span style="font-size:11px;color:var(--muted)" id="lastRefresh">â€”</span>
    <button class="btn btn-ghost btn-sm" onclick="refreshAll()">â†» Refresh</button>
  </div>
</header>

<div class="layout">
  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="nav-section">System</div>
    <div class="nav-item active" onclick="navigate('status')">
      <span class="icon">ğŸ–¥ï¸</span> Status
    </div>
    <div class="nav-item" onclick="navigate('models')">
      <span class="icon">ğŸ§ </span> Models
    </div>
    <div class="nav-item" onclick="navigate('macros')">
      <span class="icon">âš¡</span> Macros
    </div>
    <div class="nav-item" onclick="navigate('config')">
      <span class="icon">âš™ï¸</span> Config Editor
    </div>
    
    <div class="nav-section">SKAI Network</div>
    <div class="nav-item" onclick="navigate('tasks')">
      <span class="icon">ğŸ“‹</span> Tasks
      <span class="nav-badge red" id="taskNavBadge">â€”</span>
    </div>
    <div class="nav-item" onclick="navigate('kanban')">
      <span class="icon">ğŸ“Š</span> Kanban
      <span class="nav-badge" id="kanbanBadge">â€”</span>
    </div>
    <div class="nav-item" onclick="navigate('messages')">
      <span class="icon">ğŸ’¬</span> Messages
    </div>
    <div class="nav-item" onclick="navigate('send')">
      <span class="icon">âœ‰ï¸</span> Send
    </div>
  </nav>

  <!-- Main -->
  <main class="main">
    
    <!-- STATUS PAGE -->
    <div id="page-status" class="page active">
      <div class="status-grid" id="statCards">
        <div class="stat-card loading">Loading...</div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Gateway Details</span>
        </div>
        <pre class="terminal" id="statusRaw">Loading...</pre>
      </div>
    </div>

    <!-- MODELS PAGE -->
    <div id="page-models" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Available Models</span>
          <button class="btn btn-ghost btn-sm" onclick="loadModels()">â†»</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Click a model to switch the default agent model. Current model shown in green.</p>
        <div class="model-list" id="modelList"><div class="empty">Loading...</div></div>
      </div>
    </div>

    <!-- MACROS PAGE -->
    <div id="page-macros" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">System Macros</span>
        </div>
        <div class="macros-grid">
          <button class="macro-btn" onclick="runMacro('doctor')">
            <div class="icon">ğŸ©º</div>
            <div class="name">Doctor</div>
            <div class="desc">Run openclaw doctor</div>
          </button>
          <button class="macro-btn" onclick="runMacro('status')">
            <div class="icon">ğŸ“Š</div>
            <div class="name">Full Status</div>
            <div class="desc">openclaw status</div>
          </button>
          <button class="macro-btn warning" onclick="runMacro('restart')">
            <div class="icon">ğŸ”„</div>
            <div class="name">Restart Gateway</div>
            <div class="desc">Stop + start gateway service</div>
          </button>
          <button class="macro-btn" onclick="runMacro('update-check')">
            <div class="icon">ğŸ”</div>
            <div class="name">Check Updates</div>
            <div class="desc">openclaw status (update info)</div>
          </button>
          <button class="macro-btn" onclick="runMacro('sessions')">
            <div class="icon">ğŸ¤–</div>
            <div class="name">List Sessions</div>
            <div class="desc">Active agent sessions</div>
          </button>
          <button class="macro-btn" onclick="runMacro('logs')">
            <div class="icon">ğŸ“œ</div>
            <div class="name">Gateway Logs</div>
            <div class="desc">Last 50 log lines</div>
          </button>
          <button class="macro-btn danger" onclick="runMacro('stop-gateway')">
            <div class="icon">â›”</div>
            <div class="name">Stop Gateway</div>
            <div class="desc">openclaw gateway stop</div>
          </button>
        </div>
        <hr class="divider">
        <div class="card-title" style="margin-bottom:8px">Macro Output</div>
        <pre class="terminal" id="macroOutput">Run a macro to see output here...</pre>
      </div>
    </div>

    <!-- CONFIG EDITOR PAGE -->
    <div id="page-config" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">openclaw.json Config Editor</span>
          <button class="btn btn-ghost btn-sm" onclick="loadConfig()">â†» Reload</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px">âš ï¸ Edit with care. Invalid JSON will be rejected. Changes require gateway restart to take effect.</p>
        <div class="editor-wrap">
          <textarea id="configEditor" spellcheck="false"></textarea>
        </div>
        <div class="editor-actions">
          <button class="btn btn-green" onclick="saveConfig()">ğŸ’¾ Save & Validate</button>
          <button class="btn btn-ghost" onclick="loadConfig()">â†© Discard Changes</button>
          <button class="btn btn-blue" onclick="runMacroRaw('restart')" style="margin-left:auto">ğŸ”„ Restart Gateway</button>
        </div>
        <div id="configStatus" style="margin-top:8px;font-size:12px;color:var(--muted)"></div>
      </div>
    </div>

    <!-- TASKS PAGE -->
    <div id="page-tasks" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Open Tasks</span>
          <button class="btn btn-ghost btn-sm" onclick="loadSkai()">â†»</button>
        </div>
        <div id="taskList"><div class="empty">Loading...</div></div>
      </div>
    </div>

    <!-- KANBAN PAGE -->
    <div id="page-kanban" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“Š Task Kanban Board</span>
          <button class="btn btn-ghost btn-sm" onclick="loadKanban()">â†» Refresh</button>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Drag-and-drop task board. Click to claim, click again to complete.</p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" class="kanban-columns">
          <div style="background:var(--surface2);border-radius:8px;padding:12px;min-height:200px">
            <div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:10px;text-transform:uppercase">ğŸ“‹ OPEN</div>
            <div id="kanban-open"><div class="empty">Loading...</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:8px;padding:12px;min-height:200px">
            <div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:10px;text-transform:uppercase">ğŸ”¥ IN PROGRESS</div>
            <div id="kanban-progress"><div class="empty">Loading...</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:8px;padding:12px;min-height:200px">
            <div style="font-size:12px;font-weight:600;color:var(--green);margin-bottom:10px;text-transform:uppercase">âœ… COMPLETE</div>
            <div id="kanban-complete"><div class="empty">Loading...</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MESSAGES PAGE -->
    <div id="page-messages" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Recent Messages</span>
          <button class="btn btn-ghost btn-sm" onclick="loadSkai()">â†»</button>
        </div>
        <div id="msgList"><div class="empty">Loading...</div></div>
      </div>
    </div>

    <!-- SEND PAGE -->
    <div id="page-send" class="page">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Send SKAI-msg</span>
        </div>
        <div class="send-form" style="flex-direction:column;align-items:stretch">
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:12px;color:var(--muted);width:60px">To:</label>
            <select id="sendTo" style="flex:1">
              <option value="ALL">ALL</option>
              <option value="martin">martin</option>
              <option value="CODEX">CODEX</option>
              <option value="fara">fara</option>
              <option value="orae">orae</option>
              <option value="cloe">cloe</option>
              <option value="amelie">amelie</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:12px;color:var(--muted);width:60px">Message:</label>
            <textarea id="sendText" rows="3" style="flex:1" placeholder="Type your message..."></textarea>
          </div>
          <div>
            <button class="btn btn-green" onclick="sendMsg()">âœ‰ï¸ Send Message</button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPage = 'status';
let statusData = null;
let skaiData = null; // relay feature

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') === \`navigate('\${page}')\`) n.classList.add('active');
  });
  currentPage = page;
  // Lazy load
  if (page === 'models') loadModels();
  if (page === 'config') loadConfig();
  if (page === 'tasks' || page === 'messages') loadSkai();
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(dateStr) {
  const ms = Date.now() - new Date(dateStr).getTime();
  const s = Math.floor(ms/1000);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatus() {
  try {
    const res = await fetch('/proxy/status');
    const data = await res.json();
    statusData = data;
    
    // Parse key metrics from raw output
    const raw = data.raw || '';
    const lines = raw.split('\n');
    const get = (keyword) => {
      const line = lines.find(l => l.includes(keyword));
      return line ? line.replace(/[â”‚â”¤â”œ]/g,'').replace(/\\s+/g,' ').trim() : null;
    };
    
    const agentLine = get('Agents');
    const gatewayLine = get('Gateway') || get('gateway');
    const updateLine = get('Update');
    const heartbeatLine = get('Heartbeat');
    const versionLine = lines[0] || '';
    
    // Stat cards
    const isRunning = raw.includes('running');
    const hasUpdate = raw.includes('available');
    const agentMatch = raw.match(/sessions (\\d+)/);
    const sessionCount = agentMatch ? agentMatch[1] : '?';
    
    document.getElementById('statCards').innerHTML = \`
      <div class="stat-card \${isRunning ? 'stat-green' : 'stat-red'}">
        <div class="stat-label">Gateway</div>
        <div class="stat-value">\${isRunning ? 'âœ…' : 'âŒ'}</div>
        <div class="stat-sub">\${isRunning ? 'Running' : 'Stopped'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sessions</div>
        <div class="stat-value">\${sessionCount}</div>
        <div class="stat-sub">active</div>
      </div>
      <div class="stat-card \${hasUpdate ? 'stat-yellow' : ''}">
        <div class="stat-label">Updates</div>
        <div class="stat-value">\${hasUpdate ? 'âš ï¸' : 'âœ…'}</div>
        <div class="stat-sub">\${hasUpdate ? 'Available' : 'Up to date'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Heartbeat</div>
        <div class="stat-value">ğŸ’“</div>
        <div class="stat-sub">\${heartbeatLine ? heartbeatLine.replace('Heartbeat','').trim().split('Â·')[0].trim() : '?'}</div>
      </div>
    \`;
    
    // Clean and display raw
    const clean = raw.replace(/[â”Œâ”â””â”˜â”œâ”¤â”¼â”€â”‚]/g, ' ').replace(/ {3,}/g, '  ');
    document.getElementById('statusRaw').textContent = clean;
    
    // Update header badge
    const badge = document.getElementById('statusBadge');
    badge.textContent = isRunning ? 'â— Running' : 'â— Stopped';
    badge.className = 'badge ' + (isRunning ? 'badge-green' : 'badge-red');
    if (hasUpdate) {
      badge.textContent = 'â— Update available';
      badge.className = 'badge badge-yellow';
    }
    
  } catch(e) {
    document.getElementById('statCards').innerHTML = '<div class="stat-card stat-red"><div class="stat-value">âŒ</div><div class="stat-sub">Error</div></div>';
    document.getElementById('statusRaw').textContent = 'Error: ' + e.message;
  }
}

// â”€â”€â”€ Models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KNOWN_MODELS = [
  { id: 'anthropic/claude-sonnet-4-5', name: 'Claude Sonnet 4.5', provider: 'Anthropic', alias: 'sonnet' },
  { id: 'anthropic/claude-haiku-4-5', name: 'Claude Haiku 4.5', provider: 'Anthropic', alias: 'haiku' },
  { id: 'opencode/claude-opus-4-5', name: 'Claude Opus 4.5', provider: 'OpenCode', alias: 'Opus' },
  { id: 'openrouter/qwen/qwen3-coder:free', name: 'Qwen3 Coder (free)', provider: 'OpenRouter', alias: 'qwen-1' },
  { id: 'openrouter/tngtech/tng-r1t-chimera:free', name: 'TNG R1T Chimera (free)', provider: 'OpenRouter', alias: 'deepseek-1' },
  { id: 'opencode/kimi-k2.5-free', name: 'Kimi K2.5 (free)', provider: 'OpenCode', alias: 'opencode-kimi' },
  { id: 'opencode/glm-4.7-free', name: 'GLM 4.7 (free)', provider: 'OpenCode', alias: 'opencode-glm' },
  { id: 'opencode/minimax-m2.1-free', name: 'MiniMax M2.1 (free)', provider: 'OpenCode', alias: 'opencode-minimax' },
  { id: 'opencode/trinity-large-preview-free', name: 'Trinity Large (free)', provider: 'OpenCode', alias: 'opencode-trinity' },
];

let currentModel = '';

async function loadModels() {
  try {
    const res = await fetch('/proxy/current-model');
    const data = await res.json();
    currentModel = data.model || '';
    renderModels();
  } catch(e) {
    renderModels();
  }
}

function renderModels() {
  const list = document.getElementById('modelList');
  list.innerHTML = KNOWN_MODELS.map(m => {
    const isActive = currentModel.includes(m.id) || currentModel === m.alias;
    return \`<div class="model-item \${isActive ? 'active-model' : ''}" onclick="switchModel('\${m.id}')">
      <div class="model-dot \${isActive ? 'active' : ''}"></div>
      <div>
        <div class="model-name">\${m.name} \${isActive ? '<span class="tag tag-green">ACTIVE</span>' : ''}</div>
        <div class="model-provider">\${m.provider} Â· \${m.alias}</div>
      </div>
      <button class="model-switch-btn" onclick="event.stopPropagation();switchModel('\${m.id}')">Switch</button>
    </div>\`;
  }).join('');
}

async function switchModel(modelId) {
  const model = KNOWN_MODELS.find(m => m.id === modelId);
  if (!confirm(\`Switch to \${model?.name || modelId}?\`)) return;
  try {
    const res = await fetch('/proxy/switch-model', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: modelId })
    });
    const data = await res.json();
    if (data.ok) {
      currentModel = modelId;
      renderModels();
      toast(\`âœ… Switched to \${model?.name}\`);
    } else {
      toast('âŒ ' + (data.error || 'Switch failed'), 'error');
    }
  } catch(e) {
    toast('âŒ ' + e.message, 'error');
  }
}

// â”€â”€â”€ Macros â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MACROS = {
  'doctor': 'openclaw doctor',
  'status': 'openclaw status',
  'restart': 'openclaw gateway restart',
  'stop-gateway': 'openclaw gateway stop',
  'update-check': 'openclaw status',
  'sessions': 'openclaw agents list',
  'logs': 'openclaw logs --lines 50',
};

async function runMacro(name) {
  document.getElementById('macroOutput').textContent = \`Running: \${MACROS[name] || name}...\\n\`;
  if (name === 'stop-gateway' && !confirm('Stop the gateway? This will interrupt all sessions.')) return;
  if (name === 'restart' && !confirm('Restart the gateway?')) return;
  try {
    const res = await fetch('/proxy/run-macro', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ macro: name })
    });
    const data = await res.json();
    document.getElementById('macroOutput').textContent = data.output || data.error || 'Done';
    toast('âœ… Macro complete');
    if (['restart','stop-gateway'].includes(name)) loadStatus();
  } catch(e) {
    document.getElementById('macroOutput').textContent = 'Error: ' + e.message;
    toast('âŒ ' + e.message, 'error');
  }
}

async function runMacroRaw(name) { await runMacro(name); }

// â”€â”€â”€ Config Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConfig() {
  document.getElementById('configStatus').textContent = 'Loading...';
  try {
    const res = await fetch('/proxy/config');
    const data = await res.json();
    document.getElementById('configEditor').value = JSON.stringify(data, null, 2);
    document.getElementById('configStatus').textContent = 'âœ… Config loaded from ~/.openclaw/openclaw.json';
  } catch(e) {
    document.getElementById('configStatus').textContent = 'âŒ Error: ' + e.message;
  }
}

async function saveConfig() {
  const text = document.getElementById('configEditor').value;
  let parsed;
  try {
    parsed = JSON.parse(text);
  } catch(e) {
    document.getElementById('configStatus').textContent = 'âŒ Invalid JSON: ' + e.message;
    toast('âŒ Invalid JSON', 'error');
    return;
  }
  try {
    const res = await fetch('/proxy/save-config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(parsed)
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('configStatus').textContent = 'âœ… Saved! Restart gateway to apply changes.';
      toast('âœ… Config saved');
    } else {
      document.getElementById('configStatus').textContent = 'âŒ ' + data.error;
      toast('âŒ Save failed', 'error');
    }
  } catch(e) {
    document.getElementById('configStatus').textContent = 'âŒ ' + e.message;
  }
}

// â”€â”€â”€ SKAI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSkai() {
  // Relay messaging is not included in SimpleClaw public build.
  // Integrate your own relay or use OpenClaw's native channels.
  document.getElementById('taskList') && (document.getElementById('taskList').innerHTML = '<div class="empty">Connect your relay in OpenClaw settings to enable task sync.</div>');
  document.getElementById('msgList') && (document.getElementById('msgList').innerHTML = '<div class="empty">Relay messaging not configured.</div>');
}

function renderTasks(msgs) {
  const tasks = msgs.filter(m => m.payload?.type === 'task' && m.payload?.status === 'open');
  const badge = document.getElementById('taskNavBadge');
  badge.textContent = tasks.length;
  badge.className = 'nav-badge' + (tasks.length > 0 ? ' red' : '');
  
  const el = document.getElementById('taskList');
  if (tasks.length === 0) {
    el.innerHTML = '<div class="empty">ğŸ‰ No open tasks!</div>';
    return;
  }
  
  el.innerHTML = tasks.map(t => {
    const pri = t.payload?.priority || 'medium';
    const title = t.payload?.title || '(untitled task)';
    const content = t.payload?.content || '';
    const assignee = t.payload?.assignee || '';
    return \`<div class="task-item \${pri}">
      <div class="task-title">\${esc(title)}</div>
      <div class="task-meta">\${pri.toUpperCase()}\${assignee ? ' Â· @' + assignee : ''} Â· \${timeAgo(t.timestamp)}</div>
      \${content ? \`<div class="task-content">\${esc(content.substring(0, 140))}</div>\` : ''}
    </div>\`;
  }).join('');
}

function renderMessages(msgs) {
  const recent = msgs.filter(m => m.payload?.type !== 'task').slice(-20).reverse();
  const el = document.getElementById('msgList');
  if (recent.length === 0) {
    el.innerHTML = '<div class="empty">No recent messages</div>';
    return;
  }
  el.innerHTML = recent.map(m => {
    const from = m.from?.agentId || m.from || '?';
    const to = m.to?.agentId || m.to || '';
    const text = m.text || m.payload?.content || '';
    return \`<div class="msg-item">
      <div class="msg-header">
        <span class="msg-from">\${esc(from)}</span>
        \${to ? \`<span style="color:var(--muted);font-size:11px">â†’</span><span class="msg-to">\${esc(to)}</span>\` : ''}
        <span class="msg-time">\${timeAgo(m.timestamp)}</span>
      </div>
      <div class="msg-text">\${esc(text.substring(0, 200))}</div>
    </div>\`;
  }).join('');
}

async function sendMsg() {
  toast('Configure a relay in OpenClaw to enable messaging.', 'info');
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  await Promise.all([loadStatus(), loadSkai()]);
  document.getElementById('lastRefresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

refreshAll();
setInterval(refreshAll, 30000);
</script>
<script src="kanban.js"></script>
</body>
</html>
